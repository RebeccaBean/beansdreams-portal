<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Authentication</title>
  <style>
    body { font-family: 'Alex Brush', sans-serif; }
    .form-container { display: none; margin-top: 20px; }
    .form-container.active { display: block; }
    button { margin-top: 10px; }
    nav { margin-bottom: 20px; }
    nav button { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>Bean's Dreams Student Portal</h2>

  <!-- Navigation -->
  <nav>
    <button onclick="showForm('signin')">Sign In</button>
    <button onclick="showForm('signup')">Sign Up</button>
    <button onclick="showForm('forgot')">Forgot Password</button>
    <button onclick="showForm('reset')">Reset Password</button>
  </nav>

  <!-- Sign In -->
  <div id="signin" class="form-container active">
    <form id="signinForm">
      <input type="email" id="signinEmail" placeholder="Email" required><br>
      <input type="password" id="signinPassword" placeholder="Password" required><br>
      <button type="submit">Sign In</button>
    </form>
    <p id="signinMessage"></p>
  </div>

  <!-- Sign Up -->
  <div id="signup" class="form-container">
    <form id="signupForm">
      <input type="text" id="signupName" placeholder="Name" required><br>
      <input type="email" id="signupEmail" placeholder="Email" required><br>
      <input type="password" id="signupPassword" placeholder="Password" required><br>
      <select id="signupRole">
        <option value="student">Student</option>
        <option value="teacher">Teacher</option>
        <option value="admin">Admin</option>
      </select><br>
      <button type="submit">Sign Up</button>
    </form>
    <p id="signupMessage"></p>
  </div>

  <!-- Forgot Password -->
  <div id="forgot" class="form-container">
    <form id="forgotForm">
      <input type="email" id="forgotEmail" placeholder="Email" required><br>
      <button type="submit">Send Reset Link</button>
    </form>
    <p id="forgotMessage"></p>
  </div>

  <!-- Reset Password -->
  <div id="reset" class="form-container">
    <form id="resetForm">
      <input type="text" id="resetToken" placeholder="Reset Token" required><br>
      <input type="password" id="newPassword" placeholder="New Password" required><br>
      <button type="submit">Reset Password</button>
    </form>
    <p id="resetMessage"></p>
  </div>

  <script>
    // Toggle forms
    function showForm(id) {
      document.querySelectorAll('.form-container').forEach(div => div.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // Sign In
    document.getElementById('signinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value;
      try {
        const res = await fetch('http://localhost:5000/auth/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.setItem('token', data.token);
          document.getElementById('signinMessage').innerText = 'Signed in successfully!';
        } else {
          document.getElementById('signinMessage').innerText = data.message || 'Error signing in';
        }
      } catch {
        document.getElementById('signinMessage').innerText = 'Network error';
      }
    });

    // Sign Up
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const role = document.getElementById('signupRole').value;
      try {
        const res = await fetch('http://localhost:5000/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password, role })
        });
        const data = await res.json();
        document.getElementById('signupMessage').innerText = 
          res.ok ? `Signed up: ${data.email}` : data.message || 'Error signing up';
      } catch {
        document.getElementById('signupMessage').innerText = 'Network error';
      }
    });

   import nodemailer from 'nodemailer';

// Forgot Password
router.post('/forgot-password', async (req, res) => {
  const { email } = req.body;
  try {
    const token = crypto.randomBytes(32).toString('hex');
    const expiry = new Date(Date.now() + 3600000); // 1 hour
    const student = await db.students.findOne({ where: { email } });
    if (!student) return res.status(400).send('User not found');

    student.reset_token = token;
    student.reset_token_expiry = expiry;
    await student.save();

    // Configure mail transport (example with Gmail)
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER, // your email
        pass: process.env.EMAIL_PASS  // your app password
      }
    });

    // Send email with reset link
    const resetLink = `http://localhost:5500/auth.html?token=${token}`;
    await transporter.sendMail({
      from: process.env.EMAIL_USER,
      to: email,
      subject: 'Password Reset',
      text: `Click here to reset your password: ${resetLink}`,
      html: `<p>Click here to reset your password:</p><a href="${resetLink}">${resetLink}</a>`
    });

    res.send('Password reset link sent to your email');
  } catch (err) {
    console.error(err);
    res.status(500).send('Error generating reset link');
  }
});

    // Reset Password
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = document.getElementById('resetToken').value;
      const newPassword = document.getElementById('newPassword').value;
      try {
        const res = await fetch('http://localhost:5000/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, newPassword })
        });
        const msg = await res.text();
        document.getElementById('resetMessage').innerText = msg;
      } catch {
        document.getElementById('resetMessage').innerText = 'Network error';
      }
    });
  </script>
</body>
</html>
